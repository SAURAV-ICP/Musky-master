"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[548],{6790:function(e,t,r){r.d(t,{a:function(){return c},d:function(){return u}});var n=r(3827),o=r(4090),s=r(7212),a=r(4958);let i=(0,o.createContext)({user:null,loading:!1,error:null,mutate:async()=>{},updateWalletAddress:async()=>!1}),l="7093793454";function u(e){let{children:t}=e,[r,u]=(0,o.useState)(null);(0,o.useEffect)(()=>{let e=(()=>{try{if(console.log("Attempting to get Telegram user ID..."),window.Telegram){console.log("Telegram WebApp detected");try{let e=window.Telegram.WebApp;if(e&&e.initDataUnsafe&&e.initDataUnsafe.user){let t=e.initDataUnsafe.user;if(t&&t.id){let e=String(t.id);return console.log("Found Telegram user from WebApp:",e),e}}}catch(e){console.error("Error accessing Telegram WebApp data:",e)}let e=new URLSearchParams(window.location.search).get("tgWebAppData");if(e)try{let t=decodeURIComponent(e).match(/"id":(\d+)/);if(t&&t[1]){let e=t[1];return console.log("Found Telegram user from tgWebAppData:",e),e}}catch(e){console.error("Error parsing tgWebAppData:",e)}}{let e=new URLSearchParams(window.location.search),t=e.get("user_id")||e.get("id");if(t)return console.log("Found user_id in URL:",t),t;let r=window.location.hash,n=new URLSearchParams(r.substring(1)),o=n.get("user_id")||n.get("id");if(o)return console.log("Found user_id in hash:",o),o;let s=localStorage.getItem("telegram_user_id");if(s)return console.log("Found user_id in localStorage:",s),s}return console.warn("No Telegram user ID found. This should only happen in development."),null}catch(e){return console.error("Error getting Telegram user:",e),null}})();e?(u(e),localStorage.setItem("telegram_user_id",e),console.log("Set Telegram user ID:",e)):console.error("Failed to get a valid user ID")},[]);let{data:c,error:d,isLoading:f,mutate:g}=(0,s.ZP)(r?["user",r]:null,async e=>{let[t,r]=e;try{console.log("Fetching user data for ID:",r);let{data:e,error:t}=await a.O.from("users").select("*").eq("user_id",r).single();if(console.log("Existing user data:",e),t){if("PGRST116"===t.code){console.log("User not found, creating new user...");let{data:e,error:t}=await a.O.from("users").insert({user_id:r,telegram_id:r,balance:0,solana_balance:0,energy:1200,spin_energy:1200,last_spin_energy_reset:new Date().toISOString(),level:"1",is_admin:r===l,mining_equipment:{},mining_rate:0}).select().single();if(t)throw console.error("Error creating new user:",t),t;return console.log("New user created:",e),e}throw t}if(e&&!e.telegram_id){console.log("Updating user with telegram_id...");let{data:t,error:n}=await a.O.from("users").update({telegram_id:r}).eq("user_id",r).select().single();n?console.error("Error updating user telegram_id:",n):(console.log("User updated with telegram_id:",t),e.telegram_id=r)}if(e&&(void 0===e.spin_energy||null===e.spin_energy||0===e.spin_energy)){console.log("Updating user with spin energy...");let{data:e,error:t}=await a.O.from("users").update({spin_energy:1200,last_spin_energy_reset:new Date().toISOString()}).eq("user_id",r).select().single();if(t)throw console.error("Error updating user:",t),t;return console.log("User updated with spin energy:",e),e}if(e.last_spin_energy_reset){let t=new Date(e.last_spin_energy_reset),n=new Date;if((n.getTime()-t.getTime())/36e5>=12){console.log("Resetting spin energy after 12 hours...");let{data:e,error:t}=await a.O.from("users").update({spin_energy:1200,last_spin_energy_reset:n.toISOString()}).eq("user_id",r).select().single();if(t)throw console.error("Error resetting energy:",t),t;return console.log("Energy reset complete:",e),e}}if(!0===e.is_admin&&r!==l){console.log("Fixing incorrect admin status for user:",r);let{data:e,error:t}=await a.O.from("users").update({is_admin:r===l}).eq("user_id",r).select().single();if(t)console.error("Error fixing admin status:",t);else if(e)return console.log("Admin status fixed for user:",e),e}return e}catch(e){throw console.error("Error in user data fetching:",e),e}},{revalidateOnFocus:!1,revalidateOnReconnect:!1,refreshInterval:6e4}),p=async e=>{if(!c||!r)return console.error("Cannot update wallet address: User not logged in"),!1;try{let t=await fetch("/api/user/update-wallet",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:r,wallet_address:e})});if(!t.ok){let e=await t.json();return console.error("Failed to update wallet address:",e),!1}return await g(),!0}catch(e){return console.error("Error updating wallet address:",e),!1}};return(0,n.jsx)(i.Provider,{value:{user:c,loading:f,error:d,mutate:g,updateWalletAddress:p},children:t})}function c(){return(0,o.useContext)(i)}},4958:function(e,t,r){r.d(t,{O:function(){return a}});var n=r(9377);let o="https://pkaooixolhnhdyajwlgw.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrYW9vaXhvbGhuaGR5YWp3bGd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDQzMDEsImV4cCI6MjA1NTUyMDMwMX0.ATOLcUZaP--eojDV0ugG0bujlOkzam0q7A6e9IIKnxY";if(!o||!s)throw Error("Missing Supabase credentials");let a=(0,n.eI)(o,s)},1348:function(e,t,r){r.d(t,{M:function(){return h}});var n=r(4090),o=r(5526);function s(){let e=(0,n.useRef)(!1);return(0,o.L)(()=>(e.current=!0,()=>{e.current=!1}),[]),e}var a=r(4205),i=r(4561),l=r(2435);class u extends n.Component{getSnapshotBeforeUpdate(e){let t=this.props.childRef.current;if(t&&e.isPresent&&!this.props.isPresent){let e=this.props.sizeRef.current;e.height=t.offsetHeight||0,e.width=t.offsetWidth||0,e.top=t.offsetTop,e.left=t.offsetLeft}return null}componentDidUpdate(){}render(){return this.props.children}}function c(e){let{children:t,isPresent:r}=e,o=(0,n.useId)(),s=(0,n.useRef)(null),a=(0,n.useRef)({width:0,height:0,top:0,left:0});return(0,n.useInsertionEffect)(()=>{let{width:e,height:t,top:n,left:i}=a.current;if(r||!s.current||!e||!t)return;s.current.dataset.motionPopId=o;let l=document.createElement("style");return document.head.appendChild(l),l.sheet&&l.sheet.insertRule('\n          [data-motion-pop-id="'.concat(o,'"] {\n            position: absolute !important;\n            width: ').concat(e,"px !important;\n            height: ").concat(t,"px !important;\n            top: ").concat(n,"px !important;\n            left: ").concat(i,"px !important;\n          }\n        ")),()=>{document.head.removeChild(l)}},[r]),n.createElement(u,{isPresent:r,childRef:s,sizeRef:a},n.cloneElement(t,{ref:s}))}let d=e=>{let{children:t,initial:r,isPresent:o,onExitComplete:s,custom:a,presenceAffectsLayout:u,mode:d}=e,g=(0,l.h)(f),p=(0,n.useId)(),m=(0,n.useMemo)(()=>({id:p,initial:r,isPresent:o,custom:a,onExitComplete:e=>{for(let t of(g.set(e,!0),g.values()))if(!t)return;s&&s()},register:e=>(g.set(e,!1),()=>g.delete(e))}),u?void 0:[o]);return(0,n.useMemo)(()=>{g.forEach((e,t)=>g.set(t,!1))},[o]),n.useEffect(()=>{o||g.size||!s||s()},[o]),"popLayout"===d&&(t=n.createElement(c,{isPresent:o},t)),n.createElement(i.O.Provider,{value:m},t)};function f(){return new Map}var g=r(3856),p=r(9908);let m=e=>e.key||"",h=e=>{var t;let{children:r,custom:i,initial:l=!0,onExitComplete:u,exitBeforeEnter:c,presenceAffectsLayout:f=!0,mode:h="sync"}=e;(0,p.k)(!c,"Replace exitBeforeEnter with mode='wait'");let w=(0,n.useContext)(g.p).forceRender||function(){let e=s(),[t,r]=(0,n.useState)(0),o=(0,n.useCallback)(()=>{e.current&&r(t+1)},[t]);return[(0,n.useCallback)(()=>a.Wi.postRender(o),[o]),t]}()[0],_=s(),y=function(e){let t=[];return n.Children.forEach(e,e=>{(0,n.isValidElement)(e)&&t.push(e)}),t}(r),E=y,I=(0,n.useRef)(new Map).current,R=(0,n.useRef)(E),v=(0,n.useRef)(new Map).current,b=(0,n.useRef)(!0);if((0,o.L)(()=>{b.current=!1,function(e,t){e.forEach(e=>{let r=m(e);t.set(r,e)})}(y,v),R.current=E}),t=()=>{b.current=!0,v.clear(),I.clear()},(0,n.useEffect)(()=>()=>t(),[]),b.current)return n.createElement(n.Fragment,null,E.map(e=>n.createElement(d,{key:m(e),isPresent:!0,initial:!!l&&void 0,presenceAffectsLayout:f,mode:h},e)));E=[...E];let O=R.current.map(m),S=y.map(m),x=O.length;for(let e=0;e<x;e++){let t=O[e];-1!==S.indexOf(t)||I.has(t)||I.set(t,void 0)}return"wait"===h&&I.size&&(E=[]),I.forEach((e,t)=>{if(-1!==S.indexOf(t))return;let r=v.get(t);if(!r)return;let o=O.indexOf(t),s=e;s||(s=n.createElement(d,{key:m(r),isPresent:!1,onExitComplete:()=>{I.delete(t);let e=Array.from(v.keys()).filter(e=>!S.includes(e));if(e.forEach(e=>v.delete(e)),R.current=y.filter(r=>{let n=m(r);return n===t||e.includes(n)}),!I.size){if(!1===_.current)return;w(),u&&u()}},custom:i,presenceAffectsLayout:f,mode:h},r),I.set(t,s)),E.splice(o,0,s)}),E=E.map(e=>{let t=e.key;return I.has(t)?e:n.createElement(d,{key:m(e),isPresent:!0,presenceAffectsLayout:f,mode:h},e)}),n.createElement(n.Fragment,null,I.size?E:E.map(e=>(0,n.cloneElement)(e)))}}}]);