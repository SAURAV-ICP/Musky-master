"use strict";(()=>{var e={};e.id=148,e.ids=[148],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1808:e=>{e.exports=require("net")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},4404:e=>{e.exports=require("tls")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},9533:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>g,patchFetch:()=>j,requestAsyncStorage:()=>_,routeModule:()=>k,serverHooks:()=>f,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>h});var s={};r.r(s),r.d(s,{DELETE:()=>m,GET:()=>c,PATCH:()=>p,POST:()=>l});var a=r(5419),n=r(9108),i=r(9678),o=r(8070),u=r(6517);async function d(e){let{data:t,error:r}=await u.O.from("users").select("is_admin").eq("user_id",e).single();return!r&&!!t?.is_admin||(console.log("Admin verification failed for userId:",e,"Error:",r),!1)}async function c(e){try{let{searchParams:t}=new URL(e.url),r=t.get("userId"),s=t.get("status")||"all";if(!r)return o.Z.json({error:"User ID is required"},{status:400});if(!await d(r))return o.Z.json({error:"Unauthorized"},{status:403});let a=u.O.from("task_submissions").select(`
        *,
        users (
          username
        )
      `).order("created_at",{ascending:!1});"all"!==s&&(a=a.eq("status",s));let{data:n,error:i}=await a;if(i)return console.error("Error fetching tasks:",i),o.Z.json({error:"Failed to fetch tasks"},{status:500});return o.Z.json({tasks:n.map(e=>({id:e.id,type:e.type||"telegram",title:e.title,description:e.description,link:e.link||"#",clicks_wanted:e.clicks_wanted||0,clicks_received:e.clicks_received||0,payment_amount:e.payment_amount||0,payment_type:e.payment_type||"stars",status:e.status,created_at:e.created_at,user_id:e.user_id,button_text:e.button_text,active:"approved"===e.status,payment_amount_locked:e.payment_amount_locked||0,username:e.users?.username||"Anonymous"}))})}catch(e){return console.error("GET tasks error:",e),o.Z.json({error:"Failed to fetch tasks"},{status:500})}}async function l(e){try{let{searchParams:t}=new URL(e.url),r=t.get("userId");if(!r)return o.Z.json({error:"User ID is required"},{status:400});let s=await e.json();console.log("Received task creation request with body:",s);let{type:a,title:n,description:i,link:c,clicks_wanted:l,payment_amount:p,payment_type:m,active:k,button_text:_,user_id:y,payment_amount_locked:f}=s,w=await d(r),h="pending",g=p||0,j=f||0;if(w){if(!a||!["telegram","youtube","twitter"].includes(a))return o.Z.json({error:"Invalid or missing task type"},{status:400});if(!n||!i||!c||!p)return o.Z.json({error:"Missing required fields: title, description, link, and reward are required"},{status:400});h=k?"approved":"pending"}else{if(!y||y!==r)return o.Z.json({error:"Unauthorized user submission"},{status:403});if(!a||!["telegram","youtube","twitter"].includes(a)||!n||!i||!c||!l||!m)return o.Z.json({error:"Missing required fields for user task submission"},{status:400});if(l<1e3||l>1e6)return o.Z.json({error:"Clicks must be between 1,000 and 1,000,000"},{status:400});let e=2*l;g="stars"===m?e:e/500,j=2e3;let t="stars"===m?"stars_balance":"ton_balance",{data:s,error:d}=await u.O.from("users").select(t).eq("user_id",r).single();if(d||!s)return o.Z.json({error:"User balance not found"},{status:404});let p=s[t];if(p<g)return o.Z.json({error:"Insufficient balance"},{status:400});let{error:k}=await u.O.from("users").update({[t]:p-g}).eq("user_id",r);if(k)throw k}let{data:b,error:v}=await u.O.from("task_submissions").insert({type:a,title:n,description:i,link:c,clicks_wanted:l||0,clicks_received:0,payment_amount:g,payment_type:m||"stars",status:h,user_id:y||r,button_text:_,created_at:new Date().toISOString(),payment_amount_locked:j}).select().single();if(v)return console.error("Error creating task:",v),o.Z.json({error:"Failed to create task"},{status:500});return await u.O.realtime.channel("task_changes").send({type:"broadcast",event:"task_created",payload:{task:b}}),o.Z.json({success:!0,task:{id:b.id,type:b.type,title:b.title,description:b.description,link:b.link,clicks_wanted:b.clicks_wanted,clicks_received:b.clicks_received,payment_amount:b.payment_amount,payment_type:b.payment_type,status:b.status,created_at:b.created_at,user_id:b.user_id,button_text:b.button_text,active:"approved"===b.status,payment_amount_locked:b.payment_amount_locked}})}catch(e){return console.error("POST tasks error:",e),o.Z.json({error:"Failed to process task request"},{status:500})}}async function p(e,{params:t}){try{let r=t.id,{searchParams:s}=new URL(e.url),a=s.get("userId");if(!r||!a)return o.Z.json({error:"Task ID and User ID are required"},{status:400});if(!await d(a))return o.Z.json({error:"Unauthorized"},{status:403});let{type:n,title:i,description:c,link:l,clicks_wanted:p,payment_amount:m,payment_type:k,active:_,button_text:y,status:f,payment_amount_locked:w}=await e.json(),h={};n&&(h.type=n),i&&(h.title=i),c&&(h.description=c),l&&(h.link=l),void 0!==p&&(h.clicks_wanted=p),void 0!==m&&(h.payment_amount=m),k&&(h.payment_type=k),void 0!==_&&(h.status=_?"approved":"pending"),y&&(h.button_text=y),f&&(h.status=f),void 0!==w&&(h.payment_amount_locked=w);let{data:g,error:j}=await u.O.from("task_submissions").update(h).eq("id",r).select().single();if(j)return console.error("Error updating task:",j),o.Z.json({error:"Failed to update task"},{status:500});return await u.O.realtime.channel("task_changes").send({type:"broadcast",event:"task_updated",payload:{task:g}}),o.Z.json({success:!0,task:g})}catch(e){return console.error("PATCH tasks error:",e),o.Z.json({error:"Failed to update task"},{status:500})}}async function m(e,{params:t}){try{let r=t.id,{searchParams:s}=new URL(e.url),a=s.get("userId");if(!r||!a)return o.Z.json({error:"Task ID and User ID are required"},{status:400});if(!await d(a))return o.Z.json({error:"Unauthorized"},{status:403});let{data:n,error:i}=await u.O.from("task_submissions").select("user_id").eq("id",r).single();if(i)return console.error("Error fetching task for deletion:",i),o.Z.json({error:"Task not found"},{status:404});let{error:c}=await u.O.from("task_submissions").delete().eq("id",r);if(c)return console.error("Error deleting task:",c),o.Z.json({error:"Failed to delete task"},{status:500});return await u.O.realtime.channel("task_changes").send({type:"broadcast",event:"task_deleted",payload:{taskId:r}}),o.Z.json({success:!0})}catch(e){return console.error("DELETE tasks error:",e),o.Z.json({error:"Failed to delete task"},{status:500})}}let k=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/tasks/route",pathname:"/api/admin/tasks",filename:"route",bundlePath:"app/api/admin/tasks/route"},resolvedPagePath:"/Users/sauravlamichhane/Downloads/Musky-master/src/app/api/admin/tasks/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:_,staticGenerationAsyncStorage:y,serverHooks:f,headerHooks:w,staticGenerationBailout:h}=k,g="/api/admin/tasks/route";function j(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:y})}},6517:(e,t,r)=>{r.d(t,{O:()=>i});var s=r(7890);let a="https://pkaooixolhnhdyajwlgw.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrYW9vaXhvbGhuaGR5YWp3bGd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDQzMDEsImV4cCI6MjA1NTUyMDMwMX0.ATOLcUZaP--eojDV0ugG0bujlOkzam0q7A6e9IIKnxY";if(!a||!n)throw Error("Missing Supabase credentials");let i=(0,s.eI)(a,n)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[638,159],()=>r(9533));module.exports=s})();